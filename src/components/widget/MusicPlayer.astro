---
import { Icon } from "astro-icon/components";
import { musicPlayerConfig } from "../../config";

// 直接序列化为 JS 代码
const configStr = JSON.stringify(musicPlayerConfig);
---

<script is:inline define:vars={{ configStr }}>
	window.__MUSIC_CONFIG = JSON.parse(configStr);
	console.log('[Music] Global config loaded:', window.__MUSIC_CONFIG);
</script>

{musicPlayerConfig.enable && (
<div class="card-base p-4 music-player" id="music-player">
	<div class="flex items-center gap-3 mb-3">
		<div class="relative w-12 h-12 rounded-lg overflow-hidden flex-shrink-0 music-cover-container">
			<img 
				id="music-cover" 
				src="" 
				alt="音乐封面" 
				class="w-full h-full object-cover transition-transform duration-300 hover:scale-110"
				onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
			/>
			<div class="w-full h-full bg-gradient-to-br from-[var(--primary)]/20 to-[var(--primary)]/40 flex items-center justify-center music-cover-fallback" style="display: none;">
				<Icon name="material-symbols:music-note" class="text-white text-xl"></Icon>
			</div>
		</div>
		
		<div class="flex-1 min-w-0">
			<div id="music-title" class="font-semibold text-sm truncate mb-1 dark:text-neutral-50 transition-colors">未播放</div>
			<div id="music-artist" class="text-xs text-neutral-500 truncate">等待选择歌曲</div>
		</div>
		
		<button 
			id="play-pause-btn" 
			class="w-10 h-10 rounded-full bg-[var(--primary)]/10 hover:bg-[var(--primary)]/20 transition-all duration-300 flex items-center justify-center group active:scale-95"
			aria-label="播放/暂停"
		>
			<Icon name="material-symbols:play-arrow" class="text-[var(--primary)] text-xl transition-all group-hover:scale-110" id="play-icon"></Icon>
		</button>
	</div>
	
	<!-- 进度条 -->
	<div class="mb-3">
		<div class="relative h-2 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden cursor-pointer group" id="progress-bar">
			<div class="absolute left-0 top-0 h-full bg-gradient-to-r from-[var(--primary)] to-[var(--primary)]/80 rounded-full transition-all duration-300 relative" id="progress-fill" style="width: 0%">
				<div class="absolute right-0 top-1/2 transform translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[var(--primary)] rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"></div>
			</div>
		</div>
		<div class="flex justify-between text-xs text-neutral-500 mt-1.5 font-medium">
			<span id="current-time">0:00</span>
			<span id="total-time">0:00</span>
		</div>
	</div>
	
	<!-- 控制按钮 -->
	<div class="flex items-center justify-between gap-2">
		<div class="flex items-center gap-1.5">
			<button 
				id="prev-btn" 
				class="w-8 h-8 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-300 flex items-center justify-center active:scale-95"
				aria-label="上一首"
			>
				<Icon name="material-symbols:skip-previous" class="text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"></Icon>
			</button>
			<button 
				id="next-btn" 
				class="w-8 h-8 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-300 flex items-center justify-center active:scale-95"
				aria-label="下一首"
			>
				<Icon name="material-symbols:skip-next" class="text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"></Icon>
			</button>
		</div>
		
		<div class="flex items-center gap-2 flex-1 max-w-[120px]">
			<Icon name="material-symbols:volume-up" class="text-neutral-500 text-sm hover:text-[var(--primary)] transition-colors"></Icon>
			<div class="relative h-1.5 flex-1 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden cursor-pointer group" id="volume-bar">
				<div class="absolute left-0 top-0 h-full bg-gradient-to-r from-[var(--primary)]/70 to-[var(--primary)] rounded-full transition-all duration-300" id="volume-fill" style="width: 70%"></div>
			</div>
		</div>
		
		<button 
			id="playlist-btn" 
			class="w-8 h-8 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-300 flex items-center justify-center active:scale-95"
			aria-label="播放列表"
		>
			<Icon name="material-symbols:playlist-play" class="text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"></Icon>
		</button>
	</div>
	
	<!-- 播放列表 -->
	<div class="mt-3 border-t border-dashed border-black/10 dark:border-white/[0.15] pt-3 hidden" id="playlist">
		<div class="flex items-center justify-between mb-3">
			<div class="text-sm font-medium dark:text-neutral-50">播放列表</div>
			<div class="text-xs text-neutral-500" id="playlist-count">0 首歌曲</div>
		</div>
		<div class="space-y-1.5 max-h-40 overflow-y-auto pr-1" id="playlist-items">
			<!-- 播放列表项目将通过 JavaScript 动态生成 -->
		</div>
	</div>
	
	<!-- 音频元素 -->
	<audio id="audio-element" preload="metadata"></audio>
</div>
)}

<script define:vars={{ musicPlayerConfig }}>
	class MusicPlayer {
		constructor() {
			this.config = window.__MUSIC_CONFIG || musicPlayerConfig;
			console.log('[MusicPlayer] Config:', this.config);
			console.log('[MusicPlayer] Has playlist:', !!this.config?.playlist);
			console.log('[MusicPlayer] Playlist length:', this.config?.playlist?.length);
			
			this.currentTrackIndex = 0;
			this.isPlaying = false;
			this.audio = null;
			
			this.initializeElements();
			window.__fuwari_uiInstances = window.__fuwari_uiInstances || [];
			window.__fuwari_uiInstances.push(this);
			window.__fuwari_musicPlayer = this;
			
			this.bindEvents();
			
			// 加载第一首歌曲
			if (this.config?.playlist?.length > 0) {
				console.log('[MusicPlayer] Loading first track');
				this.loadTrack(0);
			} else {
				console.warn('[MusicPlayer] No playlist available');
			}
		}
		
		initializeElements() {
			// 共享 audio 元素
			let localAudio = document.getElementById('audio-element');
			if (!window.__fuwari_sharedAudio) {
				window.__fuwari_sharedAudio = localAudio;
				console.log('[MusicPlayer] Using local audio element');
			} else if (localAudio) {
				localAudio.remove();
				console.log('[MusicPlayer] Removed duplicate audio element');
			}
			this.audio = window.__fuwari_sharedAudio;
			
			// 获取 DOM 元素
			this.playPauseBtn = document.getElementById('play-pause-btn');
			this.playIcon = document.getElementById('play-icon');
			this.prevBtn = document.getElementById('prev-btn');
			this.nextBtn = document.getElementById('next-btn');
			this.playlistBtn = document.getElementById('playlist-btn');
			this.progressBar = document.getElementById('progress-bar');
			this.progressFill = document.getElementById('progress-fill');
			this.volumeBar = document.getElementById('volume-bar');
			this.volumeFill = document.getElementById('volume-fill');
			this.cover = document.getElementById('music-cover');
			this.title = document.getElementById('music-title');
			this.artist = document.getElementById('music-artist');
			this.currentTime = document.getElementById('current-time');
			this.totalTime = document.getElementById('total-time');
			this.playlist = document.getElementById('playlist');
			this.playlistItems = document.getElementById('playlist-items');
			
			if (this.audio) {
				this.audio.volume = this.config?.defaultVolume ?? 0.7;
			}
			console.log('[MusicPlayer] Elements initialized');
		}
		
		bindEvents() {
			if (!this.playPauseBtn) {
				console.warn('[MusicPlayer] UI elements not found, skipping bindEvents');
				return;
			}
			
			this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
			this.prevBtn?.addEventListener('click', () => this.prevTrack());
			this.nextBtn?.addEventListener('click', () => this.nextTrack());
			this.playlistBtn?.addEventListener('click', () => this.togglePlaylist());
			this.progressBar?.addEventListener('click', (e) => this.seekTo(e));
			this.volumeBar?.addEventListener('click', (e) => this.setVolume(e));
			
			if (this.audio && !window.__fuwari_audioListenersAdded) {
				this.audio.addEventListener('timeupdate', () => {
					window.__fuwari_uiInstances?.forEach(i => i.updateProgress?.());
				});
				this.audio.addEventListener('loadedmetadata', () => {
					window.__fuwari_uiInstances?.forEach(i => i.updateDuration?.());
				});
				this.audio.addEventListener('ended', () => {
					window.__fuwari_uiInstances?.[0]?.nextTrack?.();
				});
				window.__fuwari_audioListenersAdded = true;
				console.log('[MusicPlayer] Audio listeners added');
			}
			
			this.generatePlaylist();
		}
		
		loadTrack(index) {
			if (!this.config?.playlist?.[index]) {
				console.warn('[MusicPlayer] Invalid track index:', index);
				return;
			}
			
			this.currentTrackIndex = index;
			const track = this.config.playlist[index];
			console.log('[MusicPlayer] Loading track:', track.title);
			
			if (this.audio) {
				this.audio.src = track.url;
			}
			this.cover && (this.cover.src = track.cover || '');
			this.title && (this.title.textContent = track.title);
			this.artist && (this.artist.textContent = track.artist);
			this.updatePlaylistHighlight();
			
			if (this.isPlaying && this.audio) {
				this.audio.play().catch(e => console.error('[MusicPlayer] Play error:', e));
			}
		}
		
		togglePlayPause() {
			this.isPlaying ? this.pause() : this.play();
		}
		
		play() {
			if (!this.audio) return;
			this.audio.play().then(() => {
				this.isPlaying = true;
				this.playIcon && this.playIcon.setAttribute('name', 'material-symbols:pause');
				this.cover?.classList.add('playing');
			}).catch(e => console.error('[MusicPlayer] Play failed:', e));
		}
		
		pause() {
			if (!this.audio) return;
			this.audio.pause();
			this.isPlaying = false;
			this.playIcon && this.playIcon.setAttribute('name', 'material-symbols:play-arrow');
			this.cover?.classList.remove('playing');
		}
		
		prevTrack() {
			const idx = this.currentTrackIndex > 0 ? this.currentTrackIndex - 1 : (this.config?.playlist?.length || 1) - 1;
			this.loadTrack(idx);
			if (this.isPlaying) this.play();
		}
		
		nextTrack() {
			const idx = (this.currentTrackIndex + 1) % (this.config?.playlist?.length || 1);
			this.loadTrack(idx);
			if (this.isPlaying) this.play();
		}
		
		togglePlaylist() {
			this.playlist && this.playlist.classList.toggle('hidden');
		}
		
		seekTo(e) {
			if (!this.progressBar || !this.audio) return;
			const rect = this.progressBar.getBoundingClientRect();
			const percent = (e.clientX - rect.left) / rect.width;
			this.audio.currentTime = percent * this.audio.duration;
		}
		
		setVolume(e) {
			if (!this.volumeBar || !this.audio) return;
			const rect = this.volumeBar.getBoundingClientRect();
			const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
			this.audio.volume = percent;
			this.volumeFill && (this.volumeFill.style.width = `${percent * 100}%`);
		}
		
		updateProgress() {
			if (!this.audio?.duration) return;
			const percent = (this.audio.currentTime / this.audio.duration) * 100;
			this.progressFill && (this.progressFill.style.width = `${percent}%`);
			this.currentTime && (this.currentTime.textContent = this.formatTime(this.audio.currentTime));
		}
		
		updateDuration() {
			if (this.audio?.duration) {
				this.totalTime && (this.totalTime.textContent = this.formatTime(this.audio.duration));
			}
		}
		
		formatTime(seconds) {
			if (isNaN(seconds)) return '0:00';
			const mins = Math.floor(seconds / 60);
			const secs = Math.floor(seconds % 60);
			return `${mins}:${secs.toString().padStart(2, '0')}`;
		}
		
		generatePlaylist() {
			if (!this.playlistItems) {
				console.warn('[MusicPlayer] playlistItems element not found');
				return;
			}
			
			this.playlistItems.innerHTML = '';
			
			const playlistCount = document.getElementById('playlist-count');
			const count = this.config?.playlist?.length || 0;
			if (playlistCount) playlistCount.textContent = `${count} 首歌曲`;
			console.log('[MusicPlayer] Generating playlist with', count, 'tracks');
			
			if (!this.config?.playlist?.length) {
				console.warn('[MusicPlayer] No playlist data available');
				return;
			}
			
			this.config.playlist.forEach((track, index) => {
				const item = document.createElement('div');
				item.className = 'flex items-center gap-2.5 p-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 cursor-pointer transition-all duration-200 group';
				item.innerHTML = `
					<div class="w-8 h-8 rounded-lg bg-neutral-200 dark:bg-neutral-700 flex-shrink-0 overflow-hidden">
						<img src="${track.cover || ''}" alt="" class="w-full h-full object-cover" onerror="this.style.display='none'">
					</div>
					<div class="flex-1 min-w-0">
						<div class="text-xs font-medium truncate dark:text-neutral-50">${track.title}</div>
						<div class="text-xs text-neutral-500 truncate">${track.artist}</div>
					</div>
				`;
				item.addEventListener('click', () => {
					this.loadTrack(index);
					this.play();
				});
				this.playlistItems.appendChild(item);
			});
			console.log('[MusicPlayer] Playlist generated successfully');
		}
		updatePlaylistHighlight() {
			if (!this.playlistItems) return;
			Array.from(this.playlistItems.children || []).forEach((item, i) => {
				i === this.currentTrackIndex 
					? item.classList.add('bg-[var(--primary)]/10')
					: item.classList.remove('bg-[var(--primary)]/10');
			});
		}
	}
	
	// 初始化
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => new MusicPlayer());
	}
	
	.music-player #music-cover {
		animation: rotate 20s linear infinite;
		animation-play-state: paused;
	}
	
	.music-player #music-cover.playing {
		animation-play-state: running;
	}
	
	@keyframes rotate {
		from { transform: rotate(0deg); }
		to { transform: rotate(360deg); }
	}
	
	/* 播放列表滚动条样式 */
	.music-player #playlist-items::-webkit-scrollbar {
		width: 3px;
	}
	
	.music-player #playlist-items::-webkit-scrollbar-track {
		background: transparent;
	}
	
	.music-player #playlist-items::-webkit-scrollbar-thumb {
		background: rgba(0, 0, 0, 0.15);
		border-radius: 3px;
		transition: background 0.2s;
	}
	
	.music-player #playlist-items::-webkit-scrollbar-thumb:hover {
		background: rgba(0, 0, 0, 0.25);
	}
	
	@media (prefers-color-scheme: dark) {
		.music-player .music-cover-container {
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		}
		
		.music-player #playlist-items::-webkit-scrollbar-thumb {
			background: rgba(255, 255, 255, 0.15);
		}
		
		.music-player #playlist-items::-webkit-scrollbar-thumb:hover {
			background: rgba(255, 255, 255, 0.25);
		}
	}
	
	/* 音量和进度条增强效果 */
	.music-player #progress-bar:hover #progress-fill::after {
		opacity: 1;
	}
	
	/* 响应式设计 */
	@media (max-width: 640px) {
		.music-player {
			font-size: 0.9rem;
		}
		
		.music-player .flex.justify-between.gap-2 {
			gap: 1rem;
		}
	}
</style>