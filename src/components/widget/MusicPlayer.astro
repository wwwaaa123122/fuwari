---
import { Icon } from "astro-icon/components";
import { musicPlayerConfig } from "../../config";
---

{musicPlayerConfig.enable && (
<div class="card-base p-4 music-player" id="music-player">
	<div class="flex items-center gap-3 mb-3">
		<div class="relative w-12 h-12 rounded-lg overflow-hidden flex-shrink-0 music-cover-container">
			<img 
				id="music-cover" 
				src="" 
				alt="音乐封面" 
				class="w-full h-full object-cover transition-transform duration-300 hover:scale-110"
				onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
			/>
			<div class="w-full h-full bg-gradient-to-br from-[var(--primary)]/20 to-[var(--primary)]/40 flex items-center justify-center music-cover-fallback" style="display: none;">
				<Icon name="material-symbols:music-note" class="text-white text-xl"></Icon>
			</div>
		</div>
		
		<div class="flex-1 min-w-0">
			<div id="music-title" class="font-semibold text-sm truncate mb-1 dark:text-neutral-50 transition-colors">未播放</div>
			<div id="music-artist" class="text-xs text-neutral-500 truncate">等待选择歌曲</div>
		</div>
		
		<button 
			id="play-pause-btn" 
			class="w-10 h-10 rounded-full bg-[var(--primary)]/10 hover:bg-[var(--primary)]/20 transition-all duration-300 flex items-center justify-center group active:scale-95"
			aria-label="播放/暂停"
		>
			<Icon name="material-symbols:play-arrow" class="text-[var(--primary)] text-xl transition-all group-hover:scale-110" id="play-icon"></Icon>
		</button>
	</div>
	
	<!-- 进度条 -->
	<div class="mb-3">
		<div class="relative h-2 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden cursor-pointer group" id="progress-bar">
			<div class="absolute left-0 top-0 h-full bg-gradient-to-r from-[var(--primary)] to-[var(--primary)]/80 rounded-full transition-all duration-300 relative" id="progress-fill" style="width: 0%">
				<div class="absolute right-0 top-1/2 transform translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[var(--primary)] rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"></div>
			</div>
		</div>
		<div class="flex justify-between text-xs text-neutral-500 mt-1.5 font-medium">
			<span id="current-time">0:00</span>
			<span id="total-time">0:00</span>
		</div>
	</div>
	
	<!-- 控制按钮 -->
	<div class="flex items-center justify-between gap-2">
		<div class="flex items-center gap-1.5">
			<button 
				id="prev-btn" 
				class="w-8 h-8 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-300 flex items-center justify-center active:scale-95"
				aria-label="上一首"
			>
				<Icon name="material-symbols:skip-previous" class="text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"></Icon>
			</button>
			<button 
				id="next-btn" 
				class="w-8 h-8 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-300 flex items-center justify-center active:scale-95"
				aria-label="下一首"
			>
				<Icon name="material-symbols:skip-next" class="text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"></Icon>
			</button>
		</div>
		
		<div class="flex items-center gap-2 flex-1 max-w-[120px]">
			<Icon name="material-symbols:volume-up" class="text-neutral-500 text-sm hover:text-[var(--primary)] transition-colors"></Icon>
			<div class="relative h-1.5 flex-1 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden cursor-pointer group" id="volume-bar">
				<div class="absolute left-0 top-0 h-full bg-gradient-to-r from-[var(--primary)]/70 to-[var(--primary)] rounded-full transition-all duration-300" id="volume-fill" style="width: 70%"></div>
			</div>
		</div>
		
		<button 
			id="playlist-btn" 
			class="w-8 h-8 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-300 flex items-center justify-center active:scale-95"
			aria-label="播放列表"
		>
			<Icon name="material-symbols:playlist-play" class="text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"></Icon>
		</button>
	</div>
	
	<!-- 播放列表 -->
	<div class="mt-3 border-t border-dashed border-black/10 dark:border-white/[0.15] pt-3 hidden" id="playlist">
		<div class="flex items-center justify-between mb-3">
			<div class="text-sm font-medium dark:text-neutral-50">播放列表</div>
			<div class="text-xs text-neutral-500" id="playlist-count">0 首歌曲</div>
		</div>
		<div class="space-y-1.5 max-h-40 overflow-y-auto pr-1" id="playlist-items">
			<!-- 播放列表项目将通过 JavaScript 动态生成 -->
		</div>
	</div>
	
	<!-- 音频元素 -->
	<audio id="audio-element" preload="metadata"></audio>
</div>
)}

<script define:vars={{ musicPlayerConfig }}>
	class MusicPlayer {
		constructor() {
			this.config = musicPlayerConfig;
			this.currentTrackIndex = 0;
			this.isPlaying = false;
			this.audio = null;
			this.initializeElements();
			// 注册实例，便于音频事件广播到所有 UI 实例
			window.__fuwari_uiInstances = window.__fuwari_uiInstances || [];
			window.__fuwari_uiInstances.push(this);
			this.bindEvents();
			
			// 恢复全局状态（如果已存在则不重置播放）
			const globalState = window.__fuwari_musicState || null;
			if (globalState) {
				this.currentTrackIndex = globalState.currentTrackIndex ?? 0;
				this.isPlaying = globalState.isPlaying ?? false;
				this.updateUIFromState();
			} else {
				// 首次初始化：仅在 audio 为空或没有 src 时加载第一首
				if (!this.audio.src) {
					this.loadTrack(0);
				}
			}
		}
		
		initializeElements() {
			// 使用页面共享的 audio 元素，避免组件重新挂载时重置播放
			const localAudio = document.getElementById('audio-element');
			if (!window.__fuwari_sharedAudio) {
				window.__fuwari_sharedAudio = localAudio || document.createElement('audio');
				window.__fuwari_sharedAudio.id = 'audio-element';
				window.__fuwari_sharedAudio.preload = 'metadata';
				// 将共享 audio 移到 body，保证在路由变化时不被销毁
				document.body.appendChild(window.__fuwari_sharedAudio);
			} else {
				// 如果本地存在 audio（由当前组件渲染），移除它，统一使用共享的 audio
				if (localAudio && localAudio !== window.__fuwari_sharedAudio) {
					localAudio.remove();
				}
			}
			this.audio = window.__fuwari_sharedAudio;
			
			this.playPauseBtn = document.getElementById('play-pause-btn');
			this.playIcon = document.getElementById('play-icon');
			this.prevBtn = document.getElementById('prev-btn');
			this.nextBtn = document.getElementById('next-btn');
			this.playlistBtn = document.getElementById('playlist-btn');
			this.progressBar = document.getElementById('progress-bar');
			this.progressFill = document.getElementById('progress-fill');
			this.volumeBar = document.getElementById('volume-bar');
			this.volumeFill = document.getElementById('volume-fill');
			this.cover = document.getElementById('music-cover');
			this.title = document.getElementById('music-title');
			this.artist = document.getElementById('music-artist');
			this.currentTime = document.getElementById('current-time');
			this.totalTime = document.getElementById('total-time');
			this.playlist = document.getElementById('playlist');
			this.playlistItems = document.getElementById('playlist-items');
			
			// 设置初始音量（如果尚未设置）
			if (typeof this.audio.volume === 'number') {
				// 保持已存在音量，否则应用默认音量
				if (!window.__fuwari_musicState) this.audio.volume = this.config.defaultVolume;
			} else {
				this.audio.volume = this.config.defaultVolume;
			}
		}
		
		bindEvents() {
			// 播放/暂停
			this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
			
			// 上一首/下一首
			this.prevBtn.addEventListener('click', () => this.prevTrack());
			this.nextBtn.addEventListener('click', () => this.nextTrack());
			
			// 播放列表切换
			this.playlistBtn.addEventListener('click', () => this.togglePlaylist());
			
			// 进度条控制
			this.progressBar.addEventListener('click', (e) => this.seekTo(e));
			
			// 音量控制
			this.volumeBar.addEventListener('click', (e) => this.setVolume(e));
			
			// 仅为共享 audio 添加一次事件监听，并广播到所有 UI 实例
			if (!window.__fuwari_audioListenersAdded) {
				this.audio.addEventListener('timeupdate', () => {
					window.__fuwari_uiInstances.forEach(i => i.updateProgress());
				});
				this.audio.addEventListener('loadedmetadata', () => {
					window.__fuwari_uiInstances.forEach(i => i.updateDuration());
				});
				this.audio.addEventListener('ended', () => {
					// 使用第一个实例作为控制器推进下一首
					const ctrl = window.__fuwari_uiInstances && window.__fuwari_uiInstances[0];
					if (ctrl) ctrl._globalNextTrack();
				});
				window.__fuwari_audioListenersAdded = true;
			}
			
			// 生成播放列表
			this.generatePlaylist();
		}
		
		loadTrack(index) {
			if (index < 0 || index >= this.config.playlist.length) return;
			
			this.currentTrackIndex = index;
			const track = this.config.playlist[index];
			
			// 如果当前 src 已经是目标歌曲，则不重新设置以避免重置播放进度
			if (this.audio.src && this.audio.src === track.url) {
				// 仅更新 UI 信息
				this.cover.src = track.cover || '';
				this.title.textContent = track.title;
				this.artist.textContent = track.artist;
				this.updatePlaylistHighlight();
				// 更新全局状态
				window.__fuwari_musicState = { currentTrackIndex: this.currentTrackIndex, isPlaying: this.isPlaying };
				return;
			}
			
			this.audio.src = track.url;
			this.cover.src = track.cover || '';
			this.title.textContent = track.title;
			this.artist.textContent = track.artist;
			
			// 更新播放列表高亮
			this.updatePlaylistHighlight();
			
			// 更新全局状态
			window.__fuwari_musicState = { currentTrackIndex: this.currentTrackIndex, isPlaying: this.isPlaying };
			
			// 如果正在播放，自动播放新歌曲
			if (this.isPlaying) {
				this.audio.play().catch(console.error);
			}
		}
		
		togglePlayPause() {
			if (this.isPlaying) {
				this.pause();
			} else {
				this.play();
			}
		}
		
		play() {
			this.audio.play().then(() => {
				this.isPlaying = true;
				this.playIcon.setAttribute('name', 'material-symbols:pause');
				this.cover.classList.add('playing');
				window.__fuwari_musicState = { currentTrackIndex: this.currentTrackIndex, isPlaying: true };
			}).catch(console.error);
		}
		
		pause() {
			this.audio.pause();
			this.isPlaying = false;
			this.playIcon.setAttribute('name', 'material-symbols:play-arrow');
			this.cover.classList.remove('playing');
			window.__fuwari_musicState = { currentTrackIndex: this.currentTrackIndex, isPlaying: false };
		}
		
		prevTrack() {
			const prevIndex = this.currentTrackIndex > 0 
				? this.currentTrackIndex - 1 
				: this.config.playlist.length - 1;
			this.loadTrack(prevIndex);
			// 如果原本处于播放状态，继续播放
			if (this.isPlaying) this.audio.play().catch(console.error);
		}
		
		nextTrack() {
			const nextIndex = (this.currentTrackIndex + 1) % this.config.playlist.length;
			this.loadTrack(nextIndex);
			if (this.isPlaying) this.audio.play().catch(console.error);
		}
		
		// 由共享 audio 的 ended 事件调用，保证在全局推进播放
		_globalNextTrack() {
			const nextIndex = (this.currentTrackIndex + 1) % this.config.playlist.length;
			this.loadTrack(nextIndex);
			if (this.isPlaying) this.audio.play().catch(console.error);
		}
		
		togglePlaylist() {
			this.playlist.classList.toggle('hidden');
		}
		
		seekTo(e) {
			const rect = this.progressBar.getBoundingClientRect();
			const percent = (e.clientX - rect.left) / rect.width;
			this.audio.currentTime = percent * this.audio.duration;
		}
		
		setVolume(e) {
			const rect = this.volumeBar.getBoundingClientRect();
			const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
			this.audio.volume = percent;
			this.volumeFill.style.width = `${percent * 100}%`;
			// 保存体现在全局状态中
			window.__fuwari_musicState = window.__fuwari_musicState || {}; window.__fuwari_musicState.volume = percent;
		}
		
		updateProgress() {
			if (!this.audio.duration) return;
			const percent = (this.audio.currentTime / this.audio.duration) * 100;
			if (this.progressFill) this.progressFill.style.width = `${percent}%`;
			if (this.currentTime) this.currentTime.textContent = this.formatTime(this.audio.currentTime);
		}
		
		updateDuration() {
			if (this.totalTime) this.totalTime.textContent = this.formatTime(this.audio.duration);
		}
		
		formatTime(seconds) {
			if (isNaN(seconds)) return '0:00';
			const mins = Math.floor(seconds / 60);
			const secs = Math.floor(seconds % 60);
			return `${mins}:${secs.toString().padStart(2, '0')}`;
		}
		
		generatePlaylist() {
			this.playlistItems.innerHTML = '';
			
			// 更新播放列表计数
			const playlistCount = document.getElementById('playlist-count');
			if (playlistCount) {
				playlistCount.textContent = `${this.config.playlist.length} 首歌曲`;
			}
			
			this.config.playlist.forEach((track, index) => {
				const item = document.createElement('div');
				item.className = 'flex items-center gap-2.5 p-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 cursor-pointer transition-all duration-200 group';
				item.innerHTML = `
						<div class="w-8 h-8 rounded-lg overflow-hidden flex-shrink-0">
							<img src="${track.cover || ''}" alt="" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" 
								 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
							<div class="w-full h-full bg-gradient-to-br from-[var(--primary)]/20 to-[var(--primary)]/40 flex items-center justify-center" style="display: none;">
								<Icon name="material-symbols:music-note" class="text-white text-xs"></Icon>
							</div>
						</div>
						<div class="flex-1 min-w-0">
							<div class="text-xs font-medium truncate dark:text-neutral-50 group-hover:text-[var(--primary)] transition-colors">${track.title}</div>
							<div class="text-xs text-neutral-500 truncate">${track.artist}</div>
						</div>
						<div class="w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
							<Icon name="material-symbols:play-arrow" class="text-[var(--primary)] text-sm"></Icon>
						</div>
				`;
				item.addEventListener('click', () => {
					this.loadTrack(index);
					this.play();
				});
				this.playlistItems.appendChild(item);
			});
		}
		
		updatePlaylistHighlight() {
			const items = this.playlistItems ? this.playlistItems.children : [];
			for (let i = 0; i < items.length; i++) {
				if (i === this.currentTrackIndex) {
					items[i].classList.add('bg-[var(--primary)]/10');
				} else {
					items[i].classList.remove('bg-[var(--primary)]/10');
				}
			}
		}
		
		updateUIFromState() {
			const idx = this.currentTrackIndex;
			const track = this.config.playlist[idx];
			if (track) {
				this.cover && (this.cover.src = track.cover || '');
				this.title && (this.title.textContent = track.title);
				this.artist && (this.artist.textContent = track.artist);
				this.updatePlaylistHighlight();
			}
			// 设置播放按钮状态
			if (this.isPlaying) {
				this.playIcon && this.playIcon.setAttribute('name', 'material-symbols:pause');
				this.cover && this.cover.classList.add('playing');
			} else {
				this.playIcon && this.playIcon.setAttribute('name', 'material-symbols:play-arrow');
				this.cover && this.cover.classList.remove('playing');
			}
		}
		
		// 简单查找当前 src 对应的播放列表索引
		findTrackIndexBySrc(src) {
			if (!src) return null;
			for (let i = 0; i < this.config.playlist.length; i++) {
				if (this.config.playlist[i].url === src) return i;
			}
			return null;
	} else {
		new MusicPlayer();
	}
</script>

<style>
	.music-player .music-cover-container {
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}
	
	.music-player #music-cover {
		animation: rotate 20s linear infinite;
		animation-play-state: paused;
	}
	
	.music-player #music-cover.playing {
		animation-play-state: running;
	}
	
	@keyframes rotate {
		from { transform: rotate(0deg); }
		to { transform: rotate(360deg); }
	}
	
	/* 播放列表滚动条样式 */
	.music-player #playlist-items::-webkit-scrollbar {
		width: 3px;
	}
	
	.music-player #playlist-items::-webkit-scrollbar-track {
		background: transparent;
	}
	
	.music-player #playlist-items::-webkit-scrollbar-thumb {
		background: rgba(0, 0, 0, 0.15);
		border-radius: 3px;
		transition: background 0.2s;
	}
	
	.music-player #playlist-items::-webkit-scrollbar-thumb:hover {
		background: rgba(0, 0, 0, 0.25);
	}
	
	@media (prefers-color-scheme: dark) {
		.music-player .music-cover-container {
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		}
		
		.music-player #playlist-items::-webkit-scrollbar-thumb {
			background: rgba(255, 255, 255, 0.15);
		}
		
		.music-player #playlist-items::-webkit-scrollbar-thumb:hover {
			background: rgba(255, 255, 255, 0.25);
		}
	}
	
	/* 音量和进度条增强效果 */
	.music-player #progress-bar:hover #progress-fill::after {
		opacity: 1;
	}
	
	/* 响应式设计 */
	@media (max-width: 640px) {
		.music-player {
			font-size: 0.9rem;
		}
		
		.music-player .flex.justify-between.gap-2 {
			gap: 1rem;
		}
	}
</style>